<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SurveyApp - Admin Panel</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; color: #333; }
    .header { background: #1a73e8; color: #fff; padding: 20px 30px; display: flex; align-items: center; justify-content: space-between; }
    .header h1 { font-size: 22px; font-weight: 600; }
    .header .refresh-btn { background: rgba(255,255,255,0.2); border: none; color: #fff; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .header .refresh-btn:hover { background: rgba(255,255,255,0.3); }
    .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
    .api-config { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
    .api-config input { flex: 1; padding: 10px 14px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
    .api-config button { background: #1a73e8; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .api-config button:hover { background: #1557b0; }
    .tabs { display: flex; gap: 0; margin-bottom: 25px; border-bottom: 2px solid #e8eaed; }
    .tab { padding: 12px 24px; cursor: pointer; font-size: 15px; font-weight: 500; color: #666; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
    .tab:hover { color: #1a73e8; }
    .tab.active { color: #1a73e8; border-bottom-color: #1a73e8; font-weight: 600; }
    .stats { display: flex; gap: 15px; margin-bottom: 25px; }
    .stat-card { background: #fff; border-radius: 10px; padding: 18px 24px; flex: 1; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .stat-card .label { font-size: 13px; color: #666; margin-bottom: 4px; }
    .stat-card .value { font-size: 28px; font-weight: 700; color: #1a73e8; }
    .card { background: #fff; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
    .card-header { padding: 18px 24px; border-bottom: 1px solid #e8eaed; font-size: 16px; font-weight: 600; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #f8f9fa; text-align: left; padding: 12px 16px; font-size: 12px; text-transform: uppercase; color: #666; letter-spacing: 0.5px; border-bottom: 1px solid #e8eaed; }
    td { padding: 14px 16px; border-bottom: 1px solid #f0f0f0; font-size: 14px; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover { background: #f8f9fa; }
    .role-badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; background: #e8f0fe; color: #1a73e8; }
    .status-approved { color: #34a853; font-weight: 600; font-size: 12px; }
    .status-pending { color: #ea8600; font-weight: 600; font-size: 12px; }
    .btn { border: none; padding: 7px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: background 0.2s; }
    .btn-approve { background: #34a853; color: #fff; }
    .btn-approve:hover { background: #2d9249; }
    .btn-approve:disabled { background: #ccc; cursor: not-allowed; }
    .btn-remove { background: #ea4335; color: #fff; }
    .btn-remove:hover { background: #d33426; }
    .btn-save { background: #1a73e8; color: #fff; }
    .btn-save:hover { background: #1557b0; }
    .approved-text { color: #34a853; font-weight: 600; font-size: 13px; }
    .empty-state { text-align: center; padding: 60px 20px; color: #888; }
    .empty-state p { font-size: 16px; }
    .loading { text-align: center; padding: 40px; color: #888; }
    .error-msg { background: #fce8e6; color: #c5221f; padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; display: none; }
    .success-msg { background: #e6f4ea; color: #137333; padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; display: none; }
    select { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
    .module-checkboxes { display: flex; flex-wrap: wrap; gap: 6px; }
    .module-checkboxes label { display: flex; align-items: center; gap: 4px; font-size: 12px; background: #f0f2f5; padding: 3px 8px; border-radius: 4px; cursor: pointer; }
    .module-checkboxes input { cursor: pointer; }
    .actions-cell { display: flex; gap: 6px; flex-wrap: wrap; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .confirm-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .confirm-box { background: #fff; border-radius: 12px; padding: 30px; max-width: 400px; width: 90%; text-align: center; }
    .confirm-box h3 { margin-bottom: 12px; color: #ea4335; }
    .confirm-box p { margin-bottom: 20px; color: #666; }
    .confirm-box .btns { display: flex; gap: 10px; justify-content: center; }
    .confirm-box .btn-cancel { background: #f0f2f5; color: #333; }
  </style>
</head>
<body>
  <div class="header">
    <h1>SurveyApp Admin Panel</h1>
    <button class="refresh-btn" onclick="refreshCurrentTab()">Refresh</button>
  </div>

  <div class="container">
    <div class="api-config">
      <input type="text" id="apiUrl" value="http://172.20.10.7:5001" placeholder="Backend API URL">
      <button onclick="saveApiUrl()">Connect</button>
    </div>

    <div id="successMsg" class="success-msg"></div>
    <div id="errorMsg" class="error-msg"></div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('pending')">Pending Approvals</div>
      <div class="tab" onclick="switchTab('users')">All Users</div>
    </div>

    <!-- Pending Approvals Tab -->
    <div id="tab-pending" class="tab-content active">
      <div class="stats">
        <div class="stat-card">
          <div class="label">Pending Approvals</div>
          <div class="value" id="pendingCount">-</div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">Pending Registration Requests</div>
        <div id="pendingTableContainer">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>

    <!-- All Users Tab -->
    <div id="tab-users" class="tab-content">
      <div class="stats">
        <div class="stat-card">
          <div class="label">Total Users</div>
          <div class="value" id="totalCount">-</div>
        </div>
        <div class="stat-card">
          <div class="label">Approved</div>
          <div class="value" id="approvedCount">-</div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">All Users</div>
        <div id="usersTableContainer">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <div id="confirmOverlay" style="display:none;"></div>

  <script>
    let API_BASE = localStorage.getItem('surveyapp_api_url') || 'http://172.20.10.7:5001';
    document.getElementById('apiUrl').value = API_BASE;

    const ROLES = ['Government', 'ANRM', 'Academia', 'Undergraduate', 'Postgraduate', 'Naturalist'];
    const MODULES = ['bird', 'byvalvi', 'phenology', 'butterfly', 'water'];
    const MODULE_LABELS = { bird: 'Bird', byvalvi: 'Byvalvi', phenology: 'Phenology', butterfly: 'Butterfly', water: 'Water' };

    function saveApiUrl() {
      API_BASE = document.getElementById('apiUrl').value.replace(/\/+$/, '');
      localStorage.setItem('surveyapp_api_url', API_BASE);
      refreshCurrentTab();
    }

    function showError(msg) {
      const el = document.getElementById('errorMsg');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    function showSuccess(msg) {
      const el = document.getElementById('successMsg');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 4000);
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab:nth-child(${tab === 'pending' ? 1 : 2})`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
      if (tab === 'pending') loadPendingUsers();
      else loadAllUsers();
    }

    function refreshCurrentTab() {
      if (document.getElementById('tab-pending').classList.contains('active')) loadPendingUsers();
      else loadAllUsers();
    }

    // ==================== PENDING APPROVALS ====================
    async function loadPendingUsers() {
      const container = document.getElementById('pendingTableContainer');
      container.innerHTML = '<div class="loading">Loading...</div>';

      try {
        const res = await fetch(API_BASE + '/pending-users');
        const json = await res.json();
        if (json.status !== 'ok') throw new Error(json.message || 'Failed to fetch');

        const users = json.data || [];
        document.getElementById('pendingCount').textContent = users.length;

        if (users.length === 0) {
          container.innerHTML = '<div class="empty-state"><p>No pending registration requests.</p></div>';
          return;
        }

        let html = '<table><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Institute</th><th>Registered</th><th>Action</th></tr></thead><tbody>';
        users.forEach(user => {
          const name = user.firstName && user.lastName ? user.firstName + ' ' + user.lastName : user.name || 'N/A';
          const date = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A';
          html += `<tr id="prow-${user._id}">
            <td>${escapeHtml(name)}</td>
            <td>${escapeHtml(user.email)}</td>
            <td><span class="role-badge">${escapeHtml(user.role || 'N/A')}</span></td>
            <td>${escapeHtml(user.institute || 'N/A')}</td>
            <td>${date}</td>
            <td><button class="btn btn-approve" onclick="approveUser('${escapeHtml(user.email)}', '${user._id}')">Approve</button></td>
          </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (err) {
        container.innerHTML = '<div class="empty-state"><p>Failed to load data.</p></div>';
        document.getElementById('pendingCount').textContent = '-';
        showError('Error: ' + err.message);
      }
    }

    async function approveUser(email, id) {
      const btn = document.querySelector(`#prow-${id} .btn-approve`);
      if (btn) { btn.disabled = true; btn.textContent = 'Approving...'; }

      try {
        const res = await fetch(API_BASE + '/approve-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const json = await res.json();
        if (json.status === 'ok') {
          if (btn) btn.parentElement.innerHTML = '<span class="approved-text">Approved</span>';
          const count = document.getElementById('pendingCount');
          const current = parseInt(count.textContent);
          if (!isNaN(current)) count.textContent = current - 1;
          showSuccess('User ' + email + ' has been approved.');
        } else throw new Error(json.message || 'Approval failed');
      } catch (err) {
        if (btn) { btn.disabled = false; btn.textContent = 'Approve'; }
        showError('Failed to approve: ' + err.message);
      }
    }

    // ==================== ALL USERS ====================
    async function loadAllUsers() {
      const container = document.getElementById('usersTableContainer');
      container.innerHTML = '<div class="loading">Loading...</div>';

      try {
        const res = await fetch(API_BASE + '/all-users');
        const json = await res.json();
        if (json.status !== 'ok') throw new Error(json.message || 'Failed to fetch');

        const users = json.data || [];
        document.getElementById('totalCount').textContent = users.length;
        document.getElementById('approvedCount').textContent = users.filter(u => u.isApproved).length;

        if (users.length === 0) {
          container.innerHTML = '<div class="empty-state"><p>No users found.</p></div>';
          return;
        }

        let html = '<table><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Modules</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
        users.forEach(user => {
          const name = user.firstName && user.lastName ? user.firstName + ' ' + user.lastName : user.name || 'N/A';
          const statusClass = user.isApproved ? 'status-approved' : 'status-pending';
          const statusText = user.isApproved ? 'Approved' : 'Pending';
          const userModules = user.allowedModules || [];
          const uid = user._id;

          let roleSelect = `<select id="role-${uid}" onchange="updateRole('${escapeHtml(user.email)}', this.value)">`;
          ROLES.forEach(r => {
            roleSelect += `<option value="${r}" ${user.role === r ? 'selected' : ''}>${r}</option>`;
          });
          roleSelect += '</select>';

          let moduleChecks = '<div class="module-checkboxes">';
          MODULES.forEach(m => {
            const checked = userModules.includes(m) ? 'checked' : '';
            moduleChecks += `<label><input type="checkbox" value="${m}" ${checked} class="mod-cb-${uid}">${MODULE_LABELS[m]}</label>`;
          });
          moduleChecks += '</div>';

          html += `<tr id="urow-${uid}">
            <td>${escapeHtml(name)}</td>
            <td style="font-size:13px;">${escapeHtml(user.email)}</td>
            <td>${roleSelect}</td>
            <td>${moduleChecks}
              <button class="btn btn-save" style="margin-top:6px;" onclick="saveModules('${escapeHtml(user.email)}', '${uid}')">Save Modules</button>
            </td>
            <td><span class="${statusClass}">${statusText}</span></td>
            <td>
              <div class="actions-cell">
                ${!user.isApproved ? `<button class="btn btn-approve" onclick="approveFromList('${escapeHtml(user.email)}')">Approve</button>` : ''}
                <button class="btn btn-remove" onclick="confirmRemove('${escapeHtml(user.email)}', '${uid}')">Remove</button>
              </div>
            </td>
          </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (err) {
        container.innerHTML = '<div class="empty-state"><p>Failed to load data.</p></div>';
        showError('Error: ' + err.message);
      }
    }

    async function updateRole(email, role) {
      try {
        const res = await fetch(API_BASE + '/update-user-role', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, role })
        });
        const json = await res.json();
        if (json.status === 'ok') showSuccess('Role updated for ' + email);
        else throw new Error(json.message || 'Failed');
      } catch (err) {
        showError('Failed to update role: ' + err.message);
      }
    }

    async function saveModules(email, uid) {
      const checkboxes = document.querySelectorAll(`.mod-cb-${uid}:checked`);
      const modules = Array.from(checkboxes).map(cb => cb.value);

      try {
        const res = await fetch(API_BASE + '/update-user-modules', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, allowedModules: modules })
        });
        const json = await res.json();
        if (json.status === 'ok') showSuccess('Modules updated for ' + email);
        else throw new Error(json.message || 'Failed');
      } catch (err) {
        showError('Failed to update modules: ' + err.message);
      }
    }

    async function approveFromList(email) {
      try {
        const res = await fetch(API_BASE + '/approve-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const json = await res.json();
        if (json.status === 'ok') {
          showSuccess('User ' + email + ' approved.');
          loadAllUsers();
        } else throw new Error(json.message || 'Failed');
      } catch (err) {
        showError('Failed to approve: ' + err.message);
      }
    }

    function confirmRemove(email, uid) {
      const overlay = document.getElementById('confirmOverlay');
      overlay.style.display = 'flex';
      overlay.className = 'confirm-overlay';
      overlay.innerHTML = `
        <div class="confirm-box">
          <h3>Remove User</h3>
          <p>Are you sure you want to remove <strong>${escapeHtml(email)}</strong>? This user will no longer be able to log in.</p>
          <div class="btns">
            <button class="btn btn-cancel" onclick="closeConfirm()">Cancel</button>
            <button class="btn btn-remove" onclick="removeUser('${escapeHtml(email)}', '${uid}')">Remove</button>
          </div>
        </div>`;
    }

    function closeConfirm() {
      document.getElementById('confirmOverlay').style.display = 'none';
    }

    async function removeUser(email, uid) {
      closeConfirm();
      try {
        const res = await fetch(API_BASE + '/remove-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const json = await res.json();
        if (json.status === 'ok') {
          showSuccess('User ' + email + ' has been removed.');
          const row = document.getElementById(`urow-${uid}`);
          if (row) row.remove();
        } else throw new Error(json.message || 'Failed');
      } catch (err) {
        showError('Failed to remove user: ' + err.message);
      }
    }

    // Initial load
    loadPendingUsers();
  </script>
</body>
</html>
